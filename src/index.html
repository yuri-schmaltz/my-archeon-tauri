<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Archeon 3D | Professional Desk</title>
  <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/4.0.0/model-viewer.min.js"></script>
  <style>
    :root {
      --bg-app: #090B1F;
      --bg-app-elevated: #0f1730;
      --primary-500: #6366f1;
      --primary-600: #4f46e5;
      --surface-100: #1a1b26;
      --surface-200: #24283b;
      --surface-300: #2f354d;
      --text-strong: #e6ebff;
      --text-main: #c0caf5;
      --text-muted: #9ca8d4;
      --radius-12: 12px;
      --radius-8: 8px;
      --shadow-soft: 0 4px 12px rgba(0, 0, 0, 0.28);
    }

    body {
      margin: 0;
      background-color: var(--bg-app);
      color: var(--text-main);
      font-family: 'Inter', -apple-system, sans-serif;
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .header {
      padding: 16px 24px;
      border-bottom: 1px solid var(--surface-200);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .header h1 {
      margin: 0;
      font-size: 1.25rem;
      color: var(--text-strong);
      letter-spacing: -0.02em;
    }

    .main-layout {
      flex: 1;
      display: grid;
      grid-template-columns: 400px 1fr;
      overflow: hidden;
    }

    .sidebar {
      background: var(--surface-100);
      border-right: 1px solid var(--surface-200);
      display: flex;
      flex-direction: column;
      overflow-y: auto;
    }

    .viewport {
      position: relative;
      background: #000;
      display: flex;
      flex-direction: column;
    }

    model-viewer {
      width: 100%;
      height: 100%;
      background-color: #000;
    }

    .tabs {
      display: flex;
      border-bottom: 1px solid var(--surface-200);
      padding: 0 16px;
    }

    .tab-btn {
      padding: 12px 16px;
      background: none;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      font-weight: 500;
      border-bottom: 2px solid transparent;
      transition: all 0.2s;
    }

    .tab-btn.active {
      color: var(--primary-500);
      border-bottom-color: var(--primary-500);
    }

    .panel-content {
      padding: 24px;
      flex: 1;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    textarea, input, select {
      width: 100%;
      background: var(--bg-app-elevated);
      border: 1px solid var(--surface-300);
      border-radius: var(--radius-8);
      color: var(--text-strong);
      padding: 10px 12px;
      box-sizing: border-box;
      outline: none;
    }

    textarea:focus, input:focus {
      border-color: var(--primary-500);
    }

    .btn-generate {
      background: var(--primary-500);
      color: white;
      border: none;
      padding: 12px;
      border-radius: var(--radius-8);
      font-weight: 600;
      cursor: pointer;
      width: 100%;
      margin-top: 24px;
      box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
      transition: all 0.2s;
    }

    .btn-generate:hover {
      background: var(--primary-600);
      transform: translateY(-1px);
    }

    .footer {
      padding: 12px 24px;
      border-top: 1px solid var(--surface-200);
      font-size: 0.75rem;
      color: var(--text-muted);
      display: flex;
      justify-content: space-between;
    }

    /* MultiView Grid */
    .mv-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .image-upload-box {
      border: 2px dashed var(--surface-300);
      border-radius: var(--radius-8);
      aspect-ratio: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      overflow: hidden;
      position: relative;
    }

    .image-upload-box img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
    }

    .loading-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(10, 16, 35, 0.85);
      display: none;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      z-index: 100;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid var(--surface-200);
      border-top-color: var(--primary-500);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 16px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>Archeon 3D</h1>
    <div id="status-chip" style="font-size: 0.8rem; background: #10b98122; color: #10b981; padding: 4px 12px; border-radius: 20px;">Sidecar Ready</div>
  </div>

  <div class="main-layout">
    <div class="sidebar">
      <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('image')">Image</button>
        <button class="tab-btn" onclick="switchTab('multiview')">MultiView</button>
        <button class="tab-btn" onclick="switchTab('text')">Text</button>
        <button class="tab-btn" onclick="switchTab('mesh')">Mesh</button>
      </div>

      <div class="panel-content">
        <!-- Image Tab -->
        <div id="tab-image" class="content-tab">
          <div class="form-group">
            <label>Input Image</label>
            <div class="image-upload-box" onclick="triggerUpload('image-input')">
              <span id="image-placeholder">Click to upload</span>
              <img id="image-preview" src="" style="display: none;">
            </div>
            <input type="file" id="image-input" hidden onchange="handlePreview(this, 'image-preview', 'image-placeholder')">
          </div>
        </div>

        <!-- MultiView Tab -->
        <div id="tab-multiview" class="content-tab" style="display: none;">
          <div class="mv-grid">
            <div class="form-group">
              <label>Front</label>
              <div class="image-upload-box" onclick="triggerUpload('mv-front')">
                <span id="mv-front-ph">üì∏</span>
                <img id="mv-front-preview" src="" style="display: none;">
              </div>
              <input type="file" id="mv-front" hidden onchange="handlePreview(this, 'mv-front-preview', 'mv-front-ph')">
            </div>
            <div class="form-group">
              <label>Back</label>
              <div class="image-upload-box" onclick="triggerUpload('mv-back')">
                <span id="mv-back-ph">üîô</span>
                <img id="mv-back-preview" src="" style="display: none;">
              </div>
              <input type="file" id="mv-back" hidden onchange="handlePreview(this, 'mv-back-preview', 'mv-back-ph')">
            </div>
            <div class="form-group">
                <label>Left</label>
                <div class="image-upload-box" onclick="triggerUpload('mv-left')">
                  <span id="mv-left-ph">‚¨ÖÔ∏è</span>
                  <img id="mv-left-preview" src="" style="display: none;">
                </div>
                <input type="file" id="mv-left" hidden onchange="handlePreview(this, 'mv-left-preview', 'mv-left-ph')">
              </div>
              <div class="form-group">
                <label>Right</label>
                <div class="image-upload-box" onclick="triggerUpload('mv-right')">
                  <span id="mv-right-ph">‚û°Ô∏è</span>
                  <img id="mv-right-preview" src="" style="display: none;">
                </div>
                <input type="file" id="mv-right" hidden onchange="handlePreview(this, 'mv-right-preview', 'mv-right-ph')">
              </div>
          </div>
        </div>

        <!-- Text Tab -->
        <div id="tab-text" class="content-tab" style="display: none;">
          <div class="form-group">
            <label>Prompt</label>
            <textarea id="text-prompt" rows="4" placeholder="Describe the object..."></textarea>
          </div>
          <div class="form-group">
            <label>Negative Prompt</label>
            <textarea id="neg-prompt" rows="2" placeholder="Artifacts, low quality..."></textarea>
          </div>
        </div>

        <!-- Mesh Tab -->
        <div id="tab-mesh" class="content-tab" style="display: none;">
           <p style="opacity: 0.6; font-size: 0.9rem;">Mesh Prompt integration coming soon.</p>
        </div>

        <!-- Shared Settings -->
        <div style="border-top: 1px solid var(--surface-200); margin-top: 32px; padding-top: 24px;">
           <div class="form-group">
             <label>Steps</label>
             <input type="number" id="steps" value="30" min="1" max="100">
           </div>
           <div class="form-group">
            <label>Seed</label>
            <input type="number" id="seed" value="42">
          </div>
          <div class="form-group">
            <label style="display: flex; align-items: center; gap: 8px;">
              <input type="checkbox" id="do-texture" checked style="width: auto;">
              Generate Texture
            </label>
          </div>
        </div>

        <button class="btn-generate" onclick="generate()">Generate 3D Model</button>
      </div>
    </div>

    <div class="viewport">
      <div id="loader" class="loading-overlay">
        <div class="spinner"></div>
        <div id="loading-msg">Initializing Models...</div>
      </div>
      <model-viewer id="viewer" src="" camera-controls auto-rotate shadow-intensity="1" environment-image="neutral" exposure="1.0">
        <div slot="poster" style="display: flex; align-items: center; justify-content: center; height: 100%; color: var(--text-muted);">
          Result model will appear here.
        </div>
      </model-viewer>
    </div>
  </div>

  <div class="footer">
    <div>Archeon v2.0 | Tauri Native</div>
    <div id="api-status">API: Disconnected</div>
  </div>

  <script type="module">
    import { callSidecar } from "./sidecarClient.js";

    window.switchTab = (tab) => {
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      document.querySelectorAll('.content-tab').forEach(t => t.style.display = 'none');
      
      const activeBtn = Array.from(document.querySelectorAll('.tab-btn')).find(b => b.innerText.toLowerCase().includes(tab));
      if (activeBtn) activeBtn.classList.add('active');
      document.getElementById(`tab-${tab}`).style.display = 'block';
      window.activeTab = tab;
    };

    window.triggerUpload = (id) => document.getElementById(id).click();

    window.handlePreview = (input, imgId, phId) => {
      if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = (e) => {
          document.getElementById(imgId).src = e.target.result;
          document.getElementById(imgId).style.display = 'block';
          document.getElementById(phId).style.display = 'none';
        };
        reader.readAsDataURL(input.files[0]);
      }
    };

    window.generate = async () => {
      const loader = document.getElementById('loader');
      const msg = document.getElementById('loading-msg');
      loader.style.display = 'flex';
      msg.innerText = "Requesting Generation...";

      try {
        const params = {
          steps: parseInt(document.getElementById('steps').value),
          seed: parseInt(document.getElementById('seed').value),
          do_texture: document.getElementById('do-texture').checked
        };

        if (window.activeTab === 'text') {
          params.prompt = document.getElementById('text-prompt').value;
          params.neg_prompt = document.getElementById('neg-prompt').value;
        }

        // Note: For real image handling, we'd need to convert to base64 or pass paths.
        // Sidecar expected params should match what we defined in Planner/Inference.
        
        msg.innerText = "Processing (Loading models might take 20s)...";
        const result = await callSidecar({
          method: "execute_plan",
          params: {
              prompt: params.prompt || "Generate object",
              seed: params.seed
          }
        });

        if (result && result.artifacts && result.artifacts.mesh) {
           // In Tauri, we might need to convert path to URL or use a custom protocol
           const path = result.artifacts.mesh;
           document.getElementById('viewer').src = `tauri://localhost/${path}`;
        }
        
      } catch (err) {
        console.error(err);
        alert("Generation failed: " + err);
      } finally {
        loader.style.display = 'none';
      }
    };

    window.activeTab = 'image';
  </script>
</body>
</html>
